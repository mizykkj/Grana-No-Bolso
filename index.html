<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Jogos - Jogue Agora!</title>
    <link rel="stylesheet" href="style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9402908836616610"
         crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div class="top-page-actions">
            <div id="loggedInUserInfo" style="display: none;">
                <span id="loggedInUserEmail" class="user-email-display"></span>
                <a href="#" id="logoutModalButton" class="top-nav-link logout-link">Sair</a>
            </div>
            <a href="#" id="loginTriggerLink" class="top-nav-link">Login</a>
            <button id="aboutButton" class="about-button">Sobre</button>
        </div>
        <header>
            <h1>Bem-vindo à Central de Jogos!</h1>
            <p>Escolha um dos nossos jogos clássicos para se divertir.</p>
        </header>
        <nav class="game-selection">
            <h2>Escolha seu Jogo:</h2>
            <ul>
                <li><a href="snake.html" class="game-link">Jogo da Cobrinha</a></li>
                <li><a href="pong.html" class="game-link">Pong Clássico</a></li>
                <li><a href="quebra_blocos.html" class="game-link">Quebra Blocos</a></li>
            </ul>
        </nav>
        <section class="ranking-section">
            <h2>🏆 Ranking dos Melhores Jogadores 🏆</h2>
            <p>Veja quem são os mestres em nossos jogos!</p>
            <div class="ranking-game-selection">
                <button class="ranking-game-btn" data-gameid="snake">Jogo da Cobrinha</button>
                <button class="ranking-game-btn" data-gameid="pong">Pong Clássico</button>
                <button class="ranking-game-btn" data-gameid="quebra_blocos">Quebra Blocos</button>
            </div>
            <div id="rankingDisplayArea">
                <p class="ranking-placeholder">Selecione um jogo acima para ver o ranking.</p>
            </div>
        </section>
        <section class="adsense-area">
            <h2>Anúncios</h2>
            <p>Espaço reservado para anúncios do Google AdSense. <br> Configure sua conta AdSense e cole o código aqui para monetizar seu site.</p>
        </section>
        <footer>
            <p>&copy; 2025 Central de Jogos - Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="close-button about-modal-close">&times;</span>
            <h2>Sobre a Central de Jogos</h2>
            <p>Bem-vindo à Central de Jogos! ... (conteúdo do modal sobre) ... <em>- <a href="https://www.instagram.com/mizykj/" target="_blank" rel="noopener noreferrer" class="inline-link">Mizy Dev</a></em></p>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button auth-modal-close">&times;</span>
            <div class="auth-form" id="loginContainerModal">
                <h3>Acesse sua Conta</h3>
                <form id="formLoginModal">
                    <div><label for="loginEmailModal">Email:</label><input type="email" id="loginEmailModal" name="loginEmailModal" required></div>
                    <div><label for="loginSenhaModal">Senha:</label><input type="password" id="loginSenhaModal" name="loginSenhaModal" required></div>
                    <button type="submit">Entrar</button>
                </form>
                <p class="toggle-form-link">Não possui uma conta? <a href="#" id="switchToRegisterInModalLink">Crie uma</a></p>
            </div>
            <div class="auth-form" id="registroContainerModal" style="display: none;">
                <h3>Crie sua Conta</h3>
                <form id="formRegistroModal">
                    <div>
                        <label for="registroUsernameModal">Nome de Usuário (3-20 caracteres):</label> <input type="text" id="registroUsernameModal" name="registroUsernameModal" required minlength="3" maxlength="20" pattern="^[a-zA-Z0-9_]+$">
                    </div>
                    <div><label for="registroEmailModal">Email:</label><input type="email" id="registroEmailModal" name="registroEmailModal" required></div>
                    <div><label for="registroSenhaModal">Senha (mín. 6 caracteres):</label><input type="password" id="registroSenhaModal" name="registroSenhaModal" required minlength="6"></div>
                    <div><label for="registroConfirmaSenhaModal">Confirmar Senha:</label><input type="password" id="registroConfirmaSenhaModal" name="registroConfirmaSenhaModal" required minlength="6"></div>
                    <button type="submit">Registrar</button>
                </form>
                <p class="toggle-form-link">Já possui uma conta? <a href="#" id="switchToLoginInModalLink">Faça login</a></p>
            </div>
            <p id="authMessageModal" class="auth-message"></p>
        </div>
    </div>

    <script> /* Script do Modal Sobre */
        const aboutModalElement = document.getElementById('aboutModal'); const aboutBtnElement = document.getElementById('aboutButton'); if (aboutModalElement) { const aboutModalCloseBtnElement = aboutModalElement.querySelector('.about-modal-close'); if (aboutBtnElement) { aboutBtnElement.onclick = function() { aboutModalElement.style.display = 'flex'; setTimeout(function() { aboutModalElement.classList.add('modal-visible'); }, 10); document.body.classList.add('modal-open'); } } function closeAboutModal() { aboutModalElement.classList.remove('modal-visible'); document.body.classList.remove('modal-open'); setTimeout(function() { if (!aboutModalElement.classList.contains('modal-visible')) { aboutModalElement.style.display = 'none'; } }, 300); } if (aboutModalCloseBtnElement) aboutModalCloseBtnElement.onclick = closeAboutModal; window.addEventListener('click', function(event) { if (event.target == aboutModalElement) closeAboutModal(); });}
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = { /* SEUS DADOS REAIS AQUI */
        apiKey: "AIzaSyBYLGHFCAe_Go88NLg9huffQcaH65O8AxU",
        authDomain: "central-de-jogos-4bdf1.firebaseapp.com",
        projectId: "central-de-jogos-4bdf1",
        storageBucket: "central-de-jogos-4bdf1.appspot.com", // CONFIRA ESTE VALOR
        messagingSenderId: "552827412845",
        appId: "1:552827412845:web:57af946ce0b1a53a113a64",
        measurementId: "G-RDL4Y8ELKQ"
      };
      firebase.initializeApp(firebaseConfig);
      window.firebaseAuth = firebase.auth();
      window.firebaseDb = firebase.firestore();
      console.log("Firebase Compat SDKs carregados e Firebase inicializado em index.html!");
    </script>

    <script> // Script Principal para Lógica de Autenticação e Ranking
        (function() { // IIFE para escopo local
            if (!window.firebaseAuth || !window.firebaseDb) {
                console.error("Firebase Auth ou Firestore não estão prontos no index.html UI script.");
                return;
            }
            const auth = window.firebaseAuth; // Usar a instância global
            const db = window.firebaseDb;   // Usar a instância global

            // --- SELETORES PARA UI DE AUTENTICAÇÃO ---
            const loginTriggerLink = document.getElementById('loginTriggerLink');
            const loggedInUserInfo = document.getElementById('loggedInUserInfo');
            const loggedInUserEmailDisplay = document.getElementById('loggedInUserEmail');
            const logoutModalButton = document.getElementById('logoutModalButton');
            const authModalElement = document.getElementById('authModal');
            
            const authModalCloseBtnElement = authModalElement ? authModalElement.querySelector('.auth-modal-close') : null;
            const loginContainerModal = document.getElementById('loginContainerModal');
            const registroContainerModal = document.getElementById('registroContainerModal');
            const formLoginModal = document.getElementById('formLoginModal');
            const loginEmailModalInput = document.getElementById('loginEmailModal');
            const loginSenhaModalInput = document.getElementById('loginSenhaModal');
            const formRegistroModal = document.getElementById('formRegistroModal');
            const registroUsernameModalInput = document.getElementById('registroUsernameModal'); // NOVO
            const registroEmailModalInput = document.getElementById('registroEmailModal');
            const registroSenhaModalInput = document.getElementById('registroSenhaModal');
            const registroConfirmaSenhaModalInput = document.getElementById('registroConfirmaSenhaModal');
            const switchToRegisterInModalLink = document.getElementById('switchToRegisterInModalLink');
            const switchToLoginInModalLink = document.getElementById('switchToLoginInModalLink');
            const authMessageModal = document.getElementById('authMessageModal');

            function mostrarMensagemAuthModal(mensagem, tipo = 'error') {
                if (!authMessageModal) return;
                authMessageModal.textContent = mensagem;
                authMessageModal.className = 'auth-message ';
                if (tipo === 'success') authMessageModal.classList.add('success');
                else authMessageModal.classList.add('error');
            }
            function openAuthModal(view = 'login') {
                if (!authModalElement || !loginContainerModal || !registroContainerModal) return;
                if (view === 'login') { loginContainerModal.style.display = 'block'; registroContainerModal.style.display = 'none'; }
                else { loginContainerModal.style.display = 'none'; registroContainerModal.style.display = 'block'; }
                if (authMessageModal) { authMessageModal.textContent = ''; authMessageModal.className = 'auth-message'; }
                authModalElement.style.display = 'flex';
                setTimeout(() => { authModalElement.classList.add('modal-visible'); }, 10);
                document.body.classList.add('modal-open');
            }
            function closeAuthModal() {
                if (!authModalElement) return;
                authModalElement.classList.remove('modal-visible');
                document.body.classList.remove('modal-open');
                setTimeout(() => { if (!authModalElement.classList.contains('modal-visible')) { authModalElement.style.display = 'none'; }}, 300);
            }

            if (loginTriggerLink) loginTriggerLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal('login'); });
            if (authModalCloseBtnElement) authModalCloseBtnElement.onclick = closeAuthModal;
            window.addEventListener('click', function(event) { if (event.target == authModalElement) closeAuthModal(); });
            if (switchToRegisterInModalLink) switchToRegisterInModalLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal('register'); });
            if (switchToLoginInModalLink) switchToLoginInModalLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal('login'); });

            // LÓGICA DE REGISTRO ATUALIZADA
            if (formRegistroModal) {
                formRegistroModal.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = registroUsernameModalInput.value.trim();
                    const email = registroEmailModalInput.value;
                    const senha = registroSenhaModalInput.value;
                    const confirmaSenha = registroConfirmaSenhaModalInput.value;

                    if (username.length < 3 || username.length > 20) { mostrarMensagemAuthModal('Nome de usuário: 3-20 caracteres.'); return; }
                    if (!/^[a-zA-Z0-9_]+$/.test(username)) { mostrarMensagemAuthModal('Nome de usuário: apenas letras, números e _'); return; }
                    if (senha.length < 6) { mostrarMensagemAuthModal('Senha: mín. 6 caracteres.'); return; }
                    if (senha !== confirmaSenha) { mostrarMensagemAuthModal('As senhas não coincidem!'); return; }

                    try {
                        // 1. Verificar unicidade do username (convertendo para minúsculas para a verificação)
                        const usuariosRef = db.collection("usuarios");
                        const usernameLower = username.toLowerCase();
                        const querySnapshot = await usuariosRef.where("usernameLower", "==", usernameLower).limit(1).get();

                        if (!querySnapshot.empty) {
                            mostrarMensagemAuthModal('Este nome de usuário já está em uso. Escolha outro.');
                            return;
                        }

                        // 2. Criar usuário no Firebase Auth
                        const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
                        const user = userCredential.user;

                        // 3. Salvar dados do usuário no Firestore
                        await db.collection("usuarios").doc(user.uid).set({
                            username: username,
                            usernameLower: usernameLower, // Para busca e unicidade case-insensitive
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        formRegistroModal.reset();
                        // onAuthStateChanged vai fechar o modal e atualizar UI
                    } catch (error) {
                        console.error("Erro no registro (index.html):", error);
                        if (error.code === 'auth/email-already-in-use') mostrarMensagemAuthModal('Este email já está em uso.');
                        else if (error.code === 'auth/weak-password') mostrarMensagemAuthModal('Senha fraca.');
                        else mostrarMensagemAuthModal('Erro ao registrar: ' + error.message.replace('FirebaseError: ','').replace('Firebase: ',''));
                    }
                });
            }

            // LÓGICA DE LOGIN (sem alterações na funcionalidade, apenas usa 'auth')
            if (formLoginModal) {
                formLoginModal.addEventListener('submit', async (e) => {
                    e.preventDefault(); const email = loginEmailModalInput.value; const senha = loginSenhaModalInput.value;
                    try { await auth.signInWithEmailAndPassword(email, senha); formLoginModal.reset(); }
                    catch (error) { console.error("Erro no login (index.html):", error); if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email') mostrarMensagemAuthModal('Email ou senha inválidos.'); else mostrarMensagemAuthModal('Erro ao fazer login: ' + error.message.replace('FirebaseError: ','').replace('Firebase: ',''));}
                });
            }

            // LÓGICA DE LOGOUT (sem alterações na funcionalidade, apenas usa 'auth')
            if (logoutModalButton) {
                logoutModalButton.addEventListener('click', async (e) => {
                    e.preventDefault(); try { await auth.signOut(); } catch (error) { console.error("Erro no logout (index.html):", error); }
                });
            }

            // OBSERVADOR DO ESTADO DE AUTENTICAÇÃO (sem alterações na funcionalidade, apenas usa 'auth')
            auth.onAuthStateChanged(user => {
                if (user) {
                    if (loggedInUserInfo) loggedInUserInfo.style.display = 'flex';
                    if (loggedInUserEmailDisplay) loggedInUserEmailDisplay.textContent = user.email; // Poderíamos buscar o username aqui depois
                    if (loginTriggerLink) loginTriggerLink.style.display = 'none';
                    if (authModalElement && authModalElement.classList.contains('modal-visible')) closeAuthModal();
                } else {
                    if (loggedInUserInfo) loggedInUserInfo.style.display = 'none';
                    if (loginTriggerLink) loginTriggerLink.style.display = 'inline-block';
                }
            });

            // ------ LÓGICA DO RANKING ------
            const rankingGameButtons = document.querySelectorAll('.ranking-game-btn');
            const rankingDisplayArea = document.getElementById('rankingDisplayArea');
            const rankingPlaceholder = rankingDisplayArea ? rankingDisplayArea.querySelector('.ranking-placeholder') : null;

            if (rankingGameButtons.length > 0 && rankingDisplayArea && db) {
                rankingGameButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        const gameId = button.dataset.gameid;
                        rankingGameButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        if (rankingPlaceholder) rankingPlaceholder.style.display = 'none';
                        rankingDisplayArea.innerHTML = '<p class="ranking-placeholder">Carregando ranking...</p>';
                        try {
                            const scoresRef = db.collection("pontuacoes"); // Usando a instância 'db'
                            const querySnapshot = await scoresRef
                                .where("gameId", "==", gameId)
                                .orderBy("score", "desc")
                                .limit(10)
                                .get();
                            if (querySnapshot.empty) { rankingDisplayArea.innerHTML = '<p class="ranking-placeholder">Nenhuma pontuação para este jogo!</p>'; return; }
                            let rankingHtml = '<table><thead><tr><th>#</th><th>Jogador</th><th>Pontuação</th></tr></thead><tbody>';
                            let rank = 1;
                            querySnapshot.forEach(doc => {
                                const data = doc.data();
                                const userEmailEscaped = data.userEmail ? data.userEmail.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "Anônimo";
                                // Futuramente, buscaremos o username aqui com base no data.userId
                                rankingHtml += `<tr><td>${rank}</td><td>${userEmailEscaped}</td><td>${data.score}</td></tr>`;
                                rank++;
                            });
                            rankingHtml += '</tbody></table>';
                            rankingDisplayArea.innerHTML = rankingHtml;
                        } catch (error) { console.error("Erro ao buscar ranking: ", error); rankingDisplayArea.innerHTML = '<p class="ranking-placeholder" style="color: red;">Erro ao carregar o ranking.</p>';}
                    });
                });
            }
        })(); // Fim da IIFE
    </script>
</body>
</html>
